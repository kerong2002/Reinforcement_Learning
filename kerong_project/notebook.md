# RL AI Knight

### Abstract

1. 每次保存下来的5个.pt文件的作用
   - bestonline 大于100且是10的倍数的训练中，进行测试（关闭noise），选效果最好的
   - besttrainonline 在训练过程中选效果最好的
   - latestonline 最后一次训练结果，在训练中中途退出也是会保留的，下面两个不会
   - latestoptimizer 最后一次训练的optimizer结果
   - latesttarget0 最后一次训练的target_model结果
2. 游戏环境的区别：
   - V2
     - 攻击键自带初始惩罚2e-6
     - 有效攻击得到的奖励偏小(0.8->0.5)
     - gap略大0.05
     - 无事发生受到的惩罚偏小
     - 输入大小更大(160->192)
     - 长按按键时长更短更合理、长按失败的惩罚更小
     - reward计算上，不考虑用时
   - Survive
     - 只躲不打
     - reward计算上，只关心自身剩余血量
3. 代码版本的区别：
4. observation space 完全通过图像获得
   - 对截图的处理：本质上就是把连续的四个截图一起打包发给模型
     - 先通过geo定位，然后截，但是**两侧截多了**，有效信息被截没了
     - 然后把下侧血条截掉，**截少了**，转化为灰度图
     - 压缩成指定大小（160*160）
     - 增加一个维度：160\*160的np数组变为1\*160*160
     - 若希望把连续的4次截图，作为一次模型的输入，则用队列+元组的数据结构实现：建立最大长度为4的队列来方便更新，使用时转换为元组
     - 对得到的元组先np.concatenate
5. buffer是一个双端队列
6. exploration和epsilon decay区别

### ISSUE

1. 评价指标：无效操作数量、成功主动躲避次数（问题是需要人为观察计算出的）

2. 收敛应该是会动作数减小，但是目前无效动作数还是过多

3. 使用一个环境，允许人类指导

4. 研究高维动作空间：给出迭代次数下界

5. LOSS的断层式增大？

6. Q的更新周期是？每次动作？learning frequency？action frequency?

7. 如何寻找best model？（要最稳定、胜率最高而不是某次reward最大

8. double DQN？SVEA。。。

9. 验证是否有效性（改小骑士皮肤、改护符）：测试所有档次的BOSS、

   是否无泛化性

   是否有混合训练有效

   10w+步数的裁剪+挖掘、禁止操作

   人为示范的接口

### TODO

1. ~~改reward函数，删除时间的奖励，先只追求成功率，后期再考虑速度~~
2. ~~增加对于胜利次数和分布的显示~~
3. ~~增加best更新时，记录下更新位置~~
4. ~~不用V2环境跑跑试试，包括选择hkenv 160\*160，不用svea，修改save loc后缀~~
5. ~~尝试在soul warrior关卡训练，使用简单环境，修改后缀，不用epsilon decay~~
6. ~~给出一个评价指标：100次测试，比较成功率、平均reward，测一下179、513的best和besttrain~~
7. ~~用现成模型到新BOSS环境训练观察收敛速度，但是exploration用的是旧BOSS的，并测试对比效果~~
8. ~~用现成模型到新BOSS环境训练观察收敛速度，但是exploration是重新训练出来的，并测试对比效果~~
9. ~~增加动作空间（冲、砸、上劈），看收敛速度~~
10. ~~既然exploration和model关联，那一起存进saved里吧~~
11. ~~尝试exploration增大到200的旧代码~~
12. 针对毛里克的环境，修改超参
13. BOSS：
   - 草团子、白给守卫、假骑士
   - 大表哥、小姐姐、灵魂战士
   - 胡长老、毛里克、三螳螂
14. 很多小的改动都可以使收敛变快，但是如何定义收敛了
15. 研究下泛化的论文 
16. 比较hornet分支下的代码与当前区别并保留效果好的
17. buffer最后两个函数
18. 保存loss最小的模型
19. 拓展动作状态空间，加入冲刺

### LOG

1. 630 原版代码

2. 015 加上赢输奖励，没有太大提升，仍然几乎是闭眼乱打，守株待兔一直冲墙砍，可能是过拟合

3. 388 效果最好的一次，550次迭代、使用epsilon decay函数为100 / steps

4. 970 改为1000次迭代，函数也改为1000 / steps

5. 909 实现了1 2 3，但是没找到LOSS不降反升的原因

6. 179 实现了4

7. 988 实现了4同时取消了epsilon decay但是exploration没变因此无效

8. 178 实现5

9. 513 实现了4同时取消了epsilon decay

10. 实现了6

    |      | besttrain    | best         |
    | ---- | ------------ | ------------ |
    | 179  | 24.382918 98 | 24.449716 98 |
    | 513  | 23.483529 93 | 21.769154 82 |

11. 894 实现了7

    |      | besttrain    | best         |
    | ---- | ------------ | ------------ |
    | 894  | 4.409176 3   | 4.239348 3   |
    | 178  | 14.745453 57 | 14.114856 56 |

12. 164 实现了8

    |      | besttrain    | best         |
    | ---- | ------------ | ------------ |
    | 164  | 6.021111 3   | 7.346920 7   |
    | 178  | 14.056264 51 | 14.678022 63 |

13. 224 实现了9

14. 实现了10

15. 245 实现了11 17.917748 49 19.368512 69

16. 实现了12

17. 实现了13

    |                                       | besttrain                 | best                      | besttrain(Ours) | best(Ours)   |
    | ------------------------------------- | ------------------------- | ------------------------- | --------------- | ------------ |
    | Massive Moss Charger 草团子           |                           |                           |                 |              |
    | Crystal Guardian 白给守卫501(294) 618 | 2.682602 3 (14.835152 91) | 0.180630 1 (16.460430 99) | x               | 17.306405 98 |
    | False Knight 假骑士                   |                           |                           |                 |              |
    | Broken Vessel 大表哥 391 907 200-500  | 18.884274 93              | 19.162956 97              | 18.124176 92    | 18.526906 92 |
    | Hornet  小姐姐 224 870                | 13.488741 25              | 16.003566 29              | 17.423021 64    | 17.266478 51 |
    | Soul Warrior灵魂战士                  |                           |                           |                 |              |
    | Elder Hu 胡长老                       |                           |                           |                 |              |
    | Brooding Mawlek毛里克 744 946         | 26.950868 73              | 30.729855 94              | 28.564118 78    | 31.035190 93 |
    | Mantis Loads三螳螂                    |                           |                           |                 |              |

    
